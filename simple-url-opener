<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•ç¶²é é–‹å•Ÿå·¥å…·</title>
    <style>
        /* å®šç¾©é…è‰²è®Šæ•¸ (é è¨­æ·ºè‰²) */
        :root {
            --bg-body: #f4f4f9;
            --bg-container: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --border-color: #ccc;
            --input-bg: #ffffff;
            --input-disabled: #e9ecef;
            --status-bg: #e9ecef;
            --warning-bg: #fff3cd;
            --warning-text: #856404;
            --warning-border: #ffeeba;
            --log-time: #007bff;
        }

        /* æ·±è‰²æ¨¡å¼è®Šæ•¸è¦†å¯« */
        body.dark-mode {
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: #444;
            --input-bg: #2d2d2d;
            --input-disabled: #3a3a3a;
            --status-bg: #2a2a2a;
            --warning-bg: #3e3310;   /* æ·±é»ƒè‰²èƒŒæ™¯ */
            --warning-text: #ffda6a; /* æ·ºé»ƒè‰²æ–‡å­— */
            --warning-border: #5c4d18;
            --log-time: #4dabf7;
        }

        body {
            font-family: "Microsoft JhengHei", "Segoe UI", Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s; /* å¹³æ»‘éæ¸¡å‹•ç•« */
        }
        
        /* æ¨™é¡Œå€å¡Šèˆ‡åˆ‡æ›æŒ‰éˆ•çš„æ’ç‰ˆ */
        .header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        h2 { margin: 0; color: var(--text-main); }

        .theme-btn {
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-main);
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .theme-btn:hover {
            border-color: var(--text-main);
        }

        .container {
            background: var(--bg-container);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
        }

        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
            font-size: 14px;
            background-color: var(--input-bg);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        textarea:disabled {
            background-color: var(--input-disabled);
            cursor: not-allowed;
            color: var(--text-muted);
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        input[type="number"] {
            padding: 8px;
            width: 80px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-main);
        }
        input[type="number"]:disabled {
            background-color: var(--input-disabled);
        }

        button.action-btn {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            color: white;
            transition: background 0.3s, opacity 0.3s;
        }
        
        #btnStart { background-color: #28a745; }
        #btnStart:hover { background-color: #218838; }
        #btnStart:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }
        
        #btnStop { background-color: #dc3545; }
        #btnStop:hover { background-color: #c82333; }
        #btnStop:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }

        #btnCloseAll { background-color: #fd7e14; }
        #btnCloseAll:hover { background-color: #e36d0e; }
        #btnCloseAll:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }

        .status-box {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--status-bg);
            border-radius: 4px;
            border-left: 5px solid #007bff;
            transition: background-color 0.3s;
        }
        .log {
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--text-muted);
            max-height: 150px;
            overflow-y: auto;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
        }
        .log div { margin-bottom: 4px; }
        .log-time { color: var(--log-time); font-family: monospace; margin-right: 5px; }

        .warning {
            color: var(--warning-text);
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<div class="header-area">
    </div>

<div class="container">
    <div class="header-area">
        <h2>è‡ªå‹•ç¶²é é–‹å•Ÿå·¥å…·</h2>
        <button id="themeToggle" class="theme-btn" onclick="toggleTheme()">ğŸŒ™ åˆ‡æ›æ·±è‰²</button>
    </div>

    <div class="warning">
        <strong>âš ï¸ æé†’ï¼š</strong> è«‹å…è¨±ç€è¦½å™¨çš„ã€Œå½ˆå‡ºè¦–çª—ã€æ¬Šé™ï¼Œå¦å‰‡ç„¡æ³•è‡ªå‹•é–‹å•Ÿåˆ†é ã€‚ âš ï¸
    </div>

    <div>
        <label for="urlInput">è¼¸å…¥ç¶²å€åˆ—è¡¨ï¼š</label>
        <textarea id="urlInput" autocomplete="off" placeholder="ç›´æ¥è²¼ä¸Šç¶²å€(ä¸€è¡Œä¸€å€‹)å³å¯ï¼Œæœƒè‡ªå‹•å¿½ç•¥å‰é¢çš„ç·¨è™Ÿæˆ–æ–‡å­—ã€‚&#10;ä¾‹å¦‚ï¼š&#10;1ã€https://abc&#10;2. https://def"></textarea>
    </div>

    <div class="controls">
        <div>
            <label for="intervalInput">é–“éš” (ç§’)ï¼š</label>
            <input type="number" id="intervalInput" value="120" min="1" autocomplete="off">
        </div>
        <button id="btnStart" class="action-btn" onclick="startSequence()">é–‹å§‹åŸ·è¡Œ</button>
        <button id="btnStop" class="action-btn" onclick="stopSequence()" disabled>åœæ­¢åŸ·è¡Œ</button>
        <button id="btnCloseAll" class="action-btn" onclick="closeAllOpened()" disabled>é—œé–‰åˆ†é </button>
    </div>

    <div class="status-box">
        <div><strong>ç›®å‰ç‹€æ…‹ï¼š</strong> <span id="statusText">æº–å‚™å°±ç·’</span></div>
        <div id="countdown" style="margin-top:5px; color:#d9534f; font-weight:bold;"></div>
    </div>
    
    <div class="log" id="logArea"></div>
</div>

<script>
    let timer = null;
    let countdownTimer = null;
    let urls = [];
    let currentIndex = 0;
    let secondsLeft = 0;
    let openedWindows = [];

    // --- é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ– ---
    window.addEventListener('load', function() {
        resetControls();
        loadThemePreference(); // è¼‰å…¥ä¸Šæ¬¡çš„ä¸»é¡Œè¨­å®š
    });

    // --- æ·±è‰²æ¨¡å¼åˆ‡æ›é‚è¼¯ ---
    function toggleTheme() {
        const body = document.body;
        const btn = document.getElementById('themeToggle');
        
        // åˆ‡æ› class
        body.classList.toggle('dark-mode');
        
        // åˆ¤æ–·ç›®å‰æ˜¯å¦ç‚ºæ·±è‰²æ¨¡å¼ï¼Œä¸¦å„²å­˜è¨­å®šèˆ‡æ›´æ–°æŒ‰éˆ•æ–‡å­—
        if (body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            btn.innerText = "â˜€ï¸ åˆ‡æ›æ·ºè‰²";
        } else {
            localStorage.setItem('theme', 'light');
            btn.innerText = "ğŸŒ™ åˆ‡æ›æ·±è‰²";
        }
    }

    function loadThemePreference() {
        const savedTheme = localStorage.getItem('theme');
        const btn = document.getElementById('themeToggle');
        
        // å¦‚æœä¸Šæ¬¡å­˜çš„æ˜¯ darkï¼Œå°±åŠ ä¸Š class
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            btn.innerText = "â˜€ï¸ åˆ‡æ›æ·ºè‰²";
        }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½é‚è¼¯ ---

    function log(message) {
        const logArea = document.getElementById('logArea');
        const time = new Date().toLocaleTimeString();
        // ä½¿ç”¨ span æ¨™ç±¤è®“æ™‚é–“é¡è‰²å¯éš¨ä¸»é¡Œè®Šæ›´
        logArea.innerHTML = `<div><span class="log-time">[${time}]</span> ${message}</div>` + logArea.innerHTML;
    }

    function resetControls() {
        document.getElementById('urlInput').disabled = false;
        document.getElementById('intervalInput').disabled = false;
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnStop').disabled = true;
        document.getElementById('btnCloseAll').disabled = true;
        document.getElementById('statusText').innerText = "æº–å‚™å°±ç·’";
        document.getElementById('countdown').innerText = "";
    }

    function startSequence() {
        const input = document.getElementById('urlInput').value;
        
        // ç¶²å€è™•ç† (Regex)
        urls = input.split('\n')
            .map(u => u.trim()) 
            .map(u => u.replace(/^.*?(?=https?:\/\/)/i, '')) 
            .filter(u => u.length > 0 && (u.startsWith('http://') || u.startsWith('https://')));

        if (urls.length === 0) {
            alert("æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ç¶²å€ï¼è«‹ç¢ºèªå…§å®¹åŒ…å« http:// æˆ– https://");
            return;
        }

        const intervalSeconds = parseInt(document.getElementById('intervalInput').value);
        if (isNaN(intervalSeconds) || intervalSeconds < 1) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é–“éš”ç§’æ•¸");
            return;
        }

        openedWindows = [];
        
        document.getElementById('urlInput').disabled = true;
        document.getElementById('intervalInput').disabled = true;
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStop').disabled = false;
        document.getElementById('btnCloseAll').disabled = false;
        
        currentIndex = 0;
        document.getElementById('statusText').innerText = "åŸ·è¡Œä¸­...";
        log(`ä»»å‹™é–‹å§‹ï¼Œå·²è§£æå‡º ${urls.length} å€‹ä¹¾æ·¨ç¶²å€ã€‚`);

        openNext();

        if (document.getElementById('statusText').innerText !== "å…¨éƒ¨å®Œæˆï¼") {
            startCountdown(intervalSeconds);
        }
    }

    function openNext() {
        if (currentIndex >= urls.length) return;

        const url = urls[currentIndex];
        
        try {
            const win = window.open(url, '_blank');
            if (!win) {
                log(`<span style="color:red">é–‹å•Ÿå¤±æ•— (è¢«æ””æˆª)ï¼š${url}</span>`);
                alert("ç€è¦½å™¨æ””æˆªäº†å½ˆå‡ºè¦–çª—ï¼Œè«‹å…è¨±æœ¬é é¢å½ˆå‡ºè¦–çª—å¾Œé‡è©¦ã€‚");
                stopSequence();
                return;
            } else {
                openedWindows.push(win);
                log(`å·²é–‹å•Ÿ (${currentIndex + 1}/${urls.length}): ${url}`);
            }
        } catch (e) {
            log(`ç™¼ç”ŸéŒ¯èª¤: ${e.message}`);
        }

        currentIndex++;

        // è‡ªå‹•åœæ­¢æª¢æŸ¥
        if (currentIndex >= urls.length) {
            stopSequence(); 
            document.getElementById('statusText').innerText = "å…¨éƒ¨å®Œæˆï¼";
            log("æ‰€æœ‰ç¶²å€å·²é–‹å•Ÿå®Œç•¢ã€‚");
        }
    }

    function startCountdown(duration) {
        secondsLeft = duration;
        updateCountdownDisplay();

        if (countdownTimer) clearInterval(countdownTimer);

        countdownTimer = setInterval(() => {
            secondsLeft--;
            updateCountdownDisplay();

            if (secondsLeft <= 0) {
                clearInterval(countdownTimer);
                openNext(); 
                
                if (currentIndex < urls.length) {
                    startCountdown(duration);
                }
            }
        }, 1000);
    }

    function updateCountdownDisplay() {
        const display = document.getElementById('countdown');
        if (secondsLeft > 0) {
            display.innerText = `ä¸‹ä¸€å€‹ç¶²å€å°‡åœ¨ ${secondsLeft} ç§’å¾Œé–‹å•Ÿ...`;
        } else {
            display.innerText = "";
        }
    }

    function stopSequence() {
        if (countdownTimer) clearInterval(countdownTimer);
        
        document.getElementById('urlInput').disabled = false;
        document.getElementById('intervalInput').disabled = false;
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnStop').disabled = true;
        
        document.getElementById('countdown').innerText = "";
        
        if (document.getElementById('statusText').innerText !== "å…¨éƒ¨å®Œæˆï¼") {
             document.getElementById('statusText').innerText = "å·²åœæ­¢";
             log("ä»»å‹™åœæ­¢ã€‚");
        }
    }

    function closeAllOpened() {
        if (openedWindows.length === 0) {
            alert("ç›®å‰æ²’æœ‰ç”±ç¨‹å¼è¨˜éŒ„çš„é–‹å•Ÿåˆ†é ã€‚");
            return;
        }

        let count = 0;
        openedWindows.forEach(win => {
            if (win && !win.closed) {
                win.close();
                count++;
            }
        });

        log(`å·²åŸ·è¡Œé—œé–‰å‹•ä½œï¼Œå…±é—œé–‰ ${count} å€‹åˆ†é ã€‚`);
        openedWindows = [];
        document.getElementById('btnCloseAll').disabled = true; 
    }
</script>

</body>
</html>
